# apps/api/Dockerfile

# 1. æ„å»ºé˜¶æ®µ
FROM node:20-slim AS builder

WORKDIR /app

# å®‰è£… pnpm å’Œ openssl (Debian ç¯å¢ƒ)
RUN apt-get update -y && apt-get install -y openssl

# å®‰è£… pnpm
RUN npm install -g pnpm

# å¤åˆ¶ä¾èµ–
COPY package.json ./
RUN pnpm install

# å¤åˆ¶æºç 
COPY . .

# ç”Ÿæˆ Prisma Client
RUN npx prisma generate

# ç¼–è¯‘
RUN pnpm run build

# 2. è¿è¡Œé˜¶æ®µ
FROM node:20-slim

WORKDIR /app

# ğŸ”¥ æ ¸å¿ƒä¼˜åŠ¿ï¼šDebian Slim åªéœ€è¦è£…ä¸€ä¸ªæ ‡å‡†çš„ openssl å³å¯ï¼Œç»æ— ç‰ˆæœ¬å†²çª
RUN apt-get update -y && apt-get install -y openssl ca-certificates

COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/prisma ./prisma

EXPOSE 4000

CMD ["npm", "run", "start:prod"]