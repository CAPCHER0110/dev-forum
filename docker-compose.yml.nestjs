version: '3.8'

services:
  # 1. æ•°æ®åº“
  postgres:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
      POSTGRES_DB: dev_forum
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - '5432:5432'
    networks:
      - forum-network

  redis:
    image: redis:7-alpine
    restart: always
    command: redis-server --appendonly yes
    ports:
      - '6379:6379'
    volumes:
      - ./data/redis:/data
    networks:
      - forum-network

  # 2. åç«¯ API
  api:
    build: 
      context: ./apps/api # æŒ‡å®šæ„å»ºç›®å½•
    restart: always
    ports:
      - '4000:4000'
    environment:
      # ğŸ”¥ è¿™é‡Œçš„ host å¿…é¡»å†™ 'postgres' (æœåŠ¡å)ï¼Œä¸èƒ½å†™ localhost
      DATABASE_URL: "postgresql://myuser:mypassword@postgres:5432/dev_forum?schema=public"
      REDIS_ADDR: "redis:6379"
    volumes:
      - ./logs:/app/logs
    depends_on:
      - postgres
      - redis
    networks:
      - forum-network

  # 3. å‰ç«¯ Web
  web:
    build: 
      context: ./apps/web
    restart: always
    ports:
      - '3000:3000'
    environment:
      # ğŸ”¥ å‘æ¥äº†ï¼
      # Server Side Fetch (RSC) å¿…é¡»è®¿é—® Docker å†…éƒ¨çš„ api æœåŠ¡å
      # Client Side Fetch (æµè§ˆå™¨) å¿…é¡»è®¿é—®å®¿ä¸»æœºçš„ localhost:4000
      # æˆ‘ä»¬è¿™é‡Œå…ˆåšæœ€ç®€å•çš„é…ç½®ï¼šè®©æœåŠ¡ç«¯è¯·æ±‚èµ°å†…éƒ¨ç½‘ç»œ
      NEXT_PUBLIC_API_URL: "http://localhost:4000" # ç»™æµè§ˆå™¨ç”¨çš„
      INTERNAL_API_URL: "http://api:4000"         # ç»™ Next.js æœåŠ¡å™¨ç”¨çš„
    depends_on:
      - api
    networks:
      - forum-network

volumes:
  postgres_data:

networks:
  forum-network: