version: '3.9' # Profile éœ€è¦ 3.9+ ç‰ˆæœ¬

services:
  postgres:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: forum_prod
    volumes:
      - postgres_prod_data:/var/lib/postgresql/data
    networks:
      - local-prod-net

  redis:
    image: redis:7-alpine
    restart: always
    command: redis-server --appendonly yes
    volumes:
      - redis_prod_data:/data
    networks:
      - local-prod-net

  # ğŸ¹ æ–¹æ¡ˆ A: Go åç«¯
  api-go:
    build: 
      context: ./apps/go-api
      dockerfile: Dockerfile
    # ğŸ”¥ å…³é”® 1: Profile æ ‡ç­¾ï¼Œåªæœ‰åŠ å‚æ•° --profile go æ‰å¯åŠ¨
    profiles: ["go"] 
    restart: always
    environment:
      # Go ä½¿ç”¨è‡ªå®šä¹‰ DSN æ ¼å¼
      DATABASE_DSN: "host=postgres user=${DB_USER} password=${DB_PASSWORD} dbname=forum_prod port=5432 sslmode=disable TimeZone=Asia/Shanghai"
      REDIS_ADDR: "redis:6379"
      JWT_SECRET: ${JWT_SECRET}
      PORT: "4000"
    depends_on:
      - postgres
      - redis
    networks:
      local-prod-net:
        # ğŸ”¥ å…³é”® 2: ç½‘ç»œåˆ«åã€‚åœ¨ Docker ç½‘ç»œé‡Œï¼Œå®ƒå°±å« "api"
        aliases:
          - api

  # ğŸ¦ æ–¹æ¡ˆ B: NestJS åç«¯
  api-nest:
    build: 
      context: ./apps/api  # å‡è®¾è¿™æ˜¯ä½  NestJS ä»£ç çš„ä½ç½®
      dockerfile: Dockerfile
    # ğŸ”¥ å…³é”® 1: Profile æ ‡ç­¾ï¼Œåªæœ‰åŠ å‚æ•° --profile nest æ‰å¯åŠ¨
    profiles: ["nest"]
    restart: always
    environment:
      # NestJS (Prisma) ä½¿ç”¨æ ‡å‡†çš„ Connection URL æ ¼å¼
      DATABASE_URL: "postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/forum_prod?schema=public"
      REDIS_URL: "redis://redis:6379"
      JWT_SECRET: ${JWT_SECRET}
      PORT: "4000"
    depends_on:
      - postgres
      - redis
    networks:
      local-prod-net:
        # ğŸ”¥ å…³é”® 2: ç½‘ç»œåˆ«åã€‚å®ƒä¹Ÿå« "api"ï¼Œéª—è¿‡ Nginx
        aliases:
          - api

  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
    restart: always
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
    # æ³¨æ„ï¼šè¿™é‡Œå»æ‰äº† depends_on: - apiï¼Œå› ä¸º api åªæ˜¯åˆ«åï¼Œä¸æ˜¯æœåŠ¡å
    # å¦‚æœå†™ depends_on: - api-go ä¼šå¯¼è‡´æ— æ³•å•ç‹¬å¯åŠ¨ nest profile
    networks:
      - local-prod-net

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.local.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - web
      # åŒç†ï¼Œå»æ‰äº†å¯¹ api çš„æ˜¾å¼ä¾èµ–ï¼Œè®© Nginx è‡ªåŠ¨é‡è¯• upstream
    networks:
      - local-prod-net

volumes:
  postgres_prod_data:
  redis_prod_data:

networks:
  local-prod-net: